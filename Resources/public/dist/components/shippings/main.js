define(["sulusalesshipping/model/shipping","sulusalesorder/model/order","sulusalesorder/util/header"],function(a,b,c){"use strict";return{initialize:function(){if(this.bindCustomEvents(),this.shipping=null,this.order=null,"list"===this.options.display)this.renderList();else if("form"===this.options.display)this.renderForm();else{if("orderList"!==this.options.display)throw"display type wrong";this.renderOrderList().then(function(){c.setHeader.call(this,this.order)}.bind(this))}},bindCustomEvents:function(){this.sandbox.on("sulu.salesshipping.shipping.delete",this.showDeleteWarning.bind(this)),this.sandbox.on("sulu.salesshipping.shipping.confirm",this.confirmStatusAction.bind(this)),this.sandbox.on("sulu.salesshipping.shipping.edit",this.editStatusAction.bind(this)),this.sandbox.on("sulu.salesshipping.shipping.ship",this.shipStatusAction.bind(this)),this.sandbox.on("sulu.salesshipping.shipping.cancel",this.cancelStatusAction.bind(this)),this.sandbox.on("sulu.salesshipping.shipping.save",this.saveAction.bind(this)),this.sandbox.on("sulu.salesshipping.shipping.load",this.loadAction.bind(this)),this.sandbox.on("sulu.salesshipping.shipping.new",this.addAction.bind(this)),this.sandbox.on("sulu.salesshipping.shippings.list",this.listAction.bind(this)),this.sandbox.on("sulu.salesshipping.orders.list",this.listOrdersAction.bind(this))},confirmStatusAction:function(){this.convertStatus("deliverynote",!0)},editStatusAction:function(){this.convertStatus("edit",!0)},shipStatusAction:function(){this.convertStatus("ship",!0).then(function(a){this.sandbox.emit("sulu.salesshipping.shipping.status-change",a)}.bind(this))},cancelStatusAction:function(){this.convertStatus("cancel",!0).then(function(a){this.sandbox.emit("sulu.salesshipping.shipping.status-change",a)}.bind(this))},convertStatus:function(a,b){b=b===!0?!0:!1;var c=this.sandbox.data.deferred();return this.shipping.set({action:a}),this.shipping.save(null,{type:"post",success:function(a){this.sandbox.logger.log("successfully changed status",a),this.loadAction(this.shipping.id,b),c.resolve()}.bind(this),error:function(){c.reject()}}),c},loadAction:function(a,b){b=b===!0,this.sandbox.emit("sulu.router.navigate","sales/shippings/edit:"+a+"/details",!0,!1,b)},showDeleteWarning:function(a){this.sandbox.emit("sulu.overlay.show-warning","sulu.overlay.be-careful","sulu.overlay.delete-desc",null,this.delShippingHandler.bind(this,a))},delShippingHandler:function(a){this.sandbox.emit("sulu.header.toolbar.item.loading","options-button"),"array"===this.sandbox.util.typeOf(a)?this.sandbox.util.foreach(a,function(a){this.deleteAction(a,function(){this.sandbox.emit("husky.datagrid.record.remove",a)}.bind(this),null)}.bind(this)):this.deleteAction(a,function(){this.sandbox.emit("sulu.router.navigate","sales/shippings")}.bind(this),null)},deleteAction:function(b,c,d){c="function"==typeof c?c:null,d="function"==typeof d?d:null,this.shipping=a.findOrCreate({id:b}),this.shipping.destroy({success:c,fail:d})},listAction:function(){this.sandbox.emit("sulu.router.navigate","sales/shippings")},listOrdersAction:function(){this.sandbox.emit("sulu.router.navigate","sales/orders")},saveAction:function(a){this.sandbox.emit("sulu.header.toolbar.item.loading","save-button"),this.shipping.set(a),this.shipping.save(null,{success:function(b){var c=b.toJSON();a.id?this.sandbox.emit("sulu.salesshipping.shipping.saved",c):(this.sandbox.emit("sulu.content.saved"),this.sandbox.emit("husky.navigation.select-item","sales/shippings"),this.sandbox.emit("sulu.router.navigate","sales/shippings/edit:"+c.id+"/overview"))}.bind(this),error:function(){this.sandbox.logger.log("error while saving profile")}.bind(this)})},addAction:function(a){a?this.sandbox.emit("sulu.router.navigate",c.getUrl.call(this,a,"shippings/add")):this.sandbox.emit("sulu.router.navigate","sales/shippings/add")},renderList:function(){var a=this.sandbox.dom.createElement('<div id="shippings-list-container"/>');this.html(a),this.sandbox.start([{name:"shippings/components/list@sulusalesshipping",options:{el:a}}])},renderOrderList:function(){var a=this.sandbox.data.deferred();return this.options.id&&(this.order=b.findOrCreate({id:this.options.id}),this.order.fetch({success:function(){var b=this.sandbox.dom.createElement('<div id="order-shippings-list-container"/>');this.html(b),this.sandbox.start([{name:"orders/components/shippings-list@sulusalesshipping",options:{el:b,data:this.order.toJSON()}}]),a.resolve()}.bind(this),error:function(){this.sandbox.logger.log("error while fetching order"),a.reject()}.bind(this)})),a.promise()},renderForm:function(){this.shipping=new a;var c,d,e,f=this.sandbox.data.deferred();return this.options.id?(this.shipping=new a({id:this.options.id}),this.shipping.fetch({success:function(a){this.startForm(f,a,null)}.bind(this),error:this.errorCallback.bind(this,f)})):this.options.orderId&&(this.order=b.findOrCreate({id:this.options.orderId}),this.shipping=this.shipping.set({order:this.order}),e=null,c=this.sandbox.data.deferred(),d=this.sandbox.data.deferred(),this.order.fetch({success:function(a){this.order=a,this.shipping.set({order:a}),c.resolve()}.bind(this),error:this.errorCallback.bind(this,f)}),this.sandbox.util.load("/admin/api/shippings/numberofshippedorderitems?orderId="+this.options.orderId).then(function(a){e=a,d.resolve()}.bind(this)),this.sandbox.data.when(c,d).then(function(){this.startForm(f,this.shipping,e)}.bind(this))),f.promise()},startForm:function(a,b,c){var d=this.sandbox.dom.createElement('<div id="shipping-form-container"/>');this.html(d),this.sandbox.start([{name:"shippings/components/form@sulusalesshipping",options:{el:d,data:b.toJSON(),shippedOrderItems:c?c:null}}]),a.resolve()},errorCallback:function(a){this.sandbox.logger.log("error while fetching shipping"),a.reject()}}});